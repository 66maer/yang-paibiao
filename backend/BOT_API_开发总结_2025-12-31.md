# Bot åç«¯æ¥å£å¼€å‘æ€»ç»“

**å¼€å‘æ—¥æœŸ**: 2025-12-31  
**å¼€å‘è€…**: Claude Sonnet 4.5  
**çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ“‹ å¼€å‘éœ€æ±‚

æ ¹æ®æœºå™¨äººå¼€å‘è¿›åº¦æ–‡æ¡£ï¼Œéœ€è¦ä¸ºä»¥ä¸‹åŠŸèƒ½æä¾›åç«¯æ¥å£æ”¯æŒï¼š

1. ä»£æŠ¥å - éœ€è¦é€šè¿‡æ˜µç§°æŸ¥è¯¢ç”¨æˆ·
2. ç™»è®°è€æ¿ - éœ€è¦é€šè¿‡æ˜µç§°æŸ¥è¯¢ç”¨æˆ·
3. å–æ¶ˆæŠ¥å - éœ€è¦æŸ¥è¯¢ç”¨æˆ·çš„æŠ¥ååˆ—è¡¨ï¼ˆå¤šæŠ¥ååœºæ™¯ï¼‰

---

## âœ… å·²å®ç°çš„æ¥å£

### 1. é€šè¿‡æ˜µç§°æœç´¢æˆå‘˜

- **ç«¯ç‚¹**: `GET /api/v2/bot/guilds/{guild_id}/members/search`
- **æ–‡ä»¶**: `backend/app/api/v2/endpoints/bot_members.py`
- **Schema**: `BotMemberInfo`, `BotMemberSearchResponse` in `backend/app/schemas/bot.py`
- **åŠŸèƒ½**:
  - æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢
  - æœç´¢èŒƒå›´åŒ…æ‹¬ï¼šnicknameã€group_nicknameã€other_nickname
  - è¿”å›åŒ¹é…çš„æ‰€æœ‰æˆå‘˜ä¿¡æ¯

### 2. æŸ¥è¯¢ç”¨æˆ·åœ¨å›¢é˜Ÿçš„æŠ¥ååˆ—è¡¨

- **ç«¯ç‚¹**: `GET /api/v2/bot/guilds/{guild_id}/teams/{team_id}/signups/{qq_number}`
- **æ–‡ä»¶**: `backend/app/api/v2/endpoints/bot_signups.py`
- **Schema**: `BotSignupInfo`, `BotUserSignupsResponse` in `backend/app/schemas/bot.py`
- **åŠŸèƒ½**:
  - æŸ¥è¯¢æŒ‡å®šç”¨æˆ·åœ¨ç‰¹å®šå›¢é˜Ÿçš„æ‰€æœ‰æœ‰æ•ˆæŠ¥å
  - æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
  - ç”¨äºå–æ¶ˆæŠ¥åæ—¶çš„å¤šé€‰åœºæ™¯

### 3. åˆ›å»ºè§’è‰²æ¥å£ä¼˜åŒ–

- **ç«¯ç‚¹**: `POST /api/v2/bot/guilds/{guild_id}/characters`
- **æ–‡ä»¶**: `backend/app/api/v2/endpoints/bot_characters.py`
- **Schema**: ä¿®æ”¹ `BotCreateCharacterRequest` in `backend/app/schemas/bot.py`
- **ä¼˜åŒ–**:
  - `server` å‚æ•°æ”¹ä¸ºå¯é€‰
  - æœªæä¾›æ—¶è‡ªåŠ¨ä½¿ç”¨ç¾¤ç»„çš„æœåŠ¡å™¨
  - ä¿æŒå‘åå…¼å®¹

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### Schema å®šä¹‰

- `backend/app/schemas/bot.py`
  - æ–°å¢ `BotMemberInfo` - æˆå‘˜ä¿¡æ¯æ¨¡å‹
  - æ–°å¢ `BotMemberSearchResponse` - æˆå‘˜æœç´¢å“åº”
  - æ–°å¢ `BotSignupInfo` - æŠ¥åä¿¡æ¯æ¨¡å‹
  - æ–°å¢ `BotUserSignupsResponse` - ç”¨æˆ·æŠ¥ååˆ—è¡¨å“åº”
  - ä¿®æ”¹ `BotCreateCharacterRequest` - server æ”¹ä¸º Optional

### API ç«¯ç‚¹å®ç°

- `backend/app/api/v2/endpoints/bot_members.py`

  - æ–°å¢ `search_members()` å‡½æ•°
  - æ·»åŠ å¯¼å…¥ `BotMemberInfo`, `BotMemberSearchResponse`

- `backend/app/api/v2/endpoints/bot_signups.py`

  - æ–°å¢ `get_user_signups()` å‡½æ•°
  - æ·»åŠ å¯¼å…¥ `BotSignupInfo`, `BotUserSignupsResponse`

- `backend/app/api/v2/endpoints/bot_characters.py`
  - ä¿®æ”¹ `create_character()` å‡½æ•°é€»è¾‘
  - æ·»åŠ  Guild æŸ¥è¯¢å’Œ server é»˜è®¤å€¼å¤„ç†
  - æ·»åŠ å¯¼å…¥ `Guild` æ¨¡å‹

### æ–‡æ¡£

- `backend/BOT_API_ä½¿ç”¨æŒ‡å—.md`

  - æ›´æ–°æ¥å£åˆ—è¡¨
  - æ·»åŠ æ–°æ¥å£è¯¦ç»†è¯´æ˜
  - æ·»åŠ ä½¿ç”¨ç¤ºä¾‹å’Œåœºæ™¯è¯´æ˜

- `backend/test_new_bot_endpoints.md` (æ–°å»º)

  - å®Œæ•´çš„æµ‹è¯•æŒ‡å—
  - åŒ…å«æ‰€æœ‰æµ‹è¯•åœºæ™¯
  - æä¾›æµ‹è¯•è„šæœ¬

- `yang_bot/å¼€å‘è¿›åº¦æ€»ç»“.md`
  - æ›´æ–°å¾…å®ŒæˆåŠŸèƒ½çŠ¶æ€
  - æ·»åŠ å·²å®ç°çš„æ¥å£æ¸…å•
  - æ›´æ–°æ€»ä½“è¿›åº¦ï¼ˆ60% -> 75%ï¼‰

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### 1. æ˜µç§°æœç´¢å®ç°

**SQL æŸ¥è¯¢é€»è¾‘**:

```python
search_pattern = f"%{nickname}%"

select(User, GuildMember)
  .join(GuildMember, GuildMember.user_id == User.id)
  .where(
    GuildMember.guild_id == guild_id,
    GuildMember.left_at.is_(None),
    User.deleted_at.is_(None),
    (
      User.nickname.like(search_pattern) |
      GuildMember.group_nickname.like(search_pattern) |
      User.other_nickname.like(search_pattern)
    )
  )
```

**ç‰¹ç‚¹**:

- ä½¿ç”¨ LIKE è¿›è¡Œæ¨¡ç³ŠåŒ¹é…
- æ”¯æŒ OR æ¡ä»¶åŒæ—¶æœç´¢ä¸‰ä¸ªå­—æ®µ
- åªè¿”å›æ´»è·ƒæˆå‘˜ï¼ˆleft_at ä¸º NULLï¼‰

### 2. æŠ¥ååˆ—è¡¨æŸ¥è¯¢å®ç°

**SQL æŸ¥è¯¢é€»è¾‘**:

```python
select(Signup).where(
  Signup.team_id == team_id,
  Signup.signup_user_id == user.id,
  Signup.cancelled_at.is_(None)
).order_by(Signup.created_at.desc())
```

**ç‰¹ç‚¹**:

- åªæŸ¥è¯¢æœ‰æ•ˆæŠ¥åï¼ˆæœªå–æ¶ˆï¼‰
- å€’åºæ’åˆ—ï¼ˆæœ€æ–°åœ¨å‰ï¼‰
- åŒ…å«å®Œæ•´çš„ signup_info JSON æ•°æ®

### 3. è§’è‰²åˆ›å»ºä¼˜åŒ–å®ç°

**æ ¸å¿ƒé€»è¾‘**:

```python
# è·å–ç¾¤ç»„ä¿¡æ¯
guild = await db.execute(select(Guild).where(Guild.id == guild_id))

# ç¡®å®šæœåŠ¡å™¨
server = payload.server if payload.server else guild.server

# ä½¿ç”¨ç¡®å®šçš„serveråˆ›å»ºè§’è‰²
character = Character(
  name=payload.name,
  server=server,  # ä½¿ç”¨è‡ªåŠ¨åˆ¤æ–­çš„server
  xinfa=payload.xinfa
)
```

**ç‰¹ç‚¹**:

- ä¼˜å…ˆä½¿ç”¨è¯·æ±‚ä¸­çš„ server
- å›é€€åˆ°ç¾¤ç»„çš„ server
- ä¿æŒå‘åå…¼å®¹

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

1. æ˜µç§°æœç´¢ï¼šç²¾ç¡®åŒ¹é…ã€æ¨¡ç³ŠåŒ¹é…ã€ç©ºç»“æœ
2. æŠ¥ååˆ—è¡¨ï¼šå•æŠ¥åã€å¤šæŠ¥åã€æ— æŠ¥å
3. è§’è‰²åˆ›å»ºï¼šå¸¦ serverã€ä¸å¸¦ serverã€éªŒè¯é»˜è®¤å€¼

### é›†æˆæµ‹è¯•

1. å®Œæ•´çš„ä»£æŠ¥åæµç¨‹
2. å®Œæ•´çš„å–æ¶ˆæŠ¥åæµç¨‹
3. é”™è¯¯åœºæ™¯ï¼ˆæ— æ•ˆ API Keyã€æœªæˆæƒç¾¤ç»„ç­‰ï¼‰

è¯¦è§ï¼š`backend/test_new_bot_endpoints.md`

---

## ğŸ“Š API å“åº”æ ¼å¼

æ‰€æœ‰æ¥å£éƒ½ä½¿ç”¨ç»Ÿä¸€çš„ `ResponseModel` æ ¼å¼ï¼š

```json
{
  "code": 200,
  "message": "success",
  "data": {
    // å…·ä½“æ•°æ®
  }
}
```

---

## ğŸš€ éƒ¨ç½²å»ºè®®

1. **æ•°æ®åº“è¿ç§»**: æ— éœ€æ–°çš„è¿ç§»ï¼ˆä½¿ç”¨ç°æœ‰è¡¨ç»“æ„ï¼‰
2. **ä»£ç éƒ¨ç½²**: é‡å¯åç«¯æœåŠ¡å³å¯
3. **API æ–‡æ¡£**: è‡ªåŠ¨æ›´æ–°åˆ° Swagger/ReDoc
4. **å‘åå…¼å®¹**: æ‰€æœ‰ä¿®æ”¹éƒ½å‘åå…¼å®¹

---

## ğŸ” å®‰å…¨è€ƒè™‘

1. **æƒé™éªŒè¯**: æ‰€æœ‰æ¥å£éƒ½é€šè¿‡ `verify_bot_guild_access` éªŒè¯ Bot æƒé™
2. **SQL æ³¨å…¥**: ä½¿ç”¨ SQLAlchemy ORMï¼Œå‚æ•°åŒ–æŸ¥è¯¢
3. **æ¨¡ç³ŠæŸ¥è¯¢**: LIKE æŸ¥è¯¢å¯èƒ½æœ‰æ€§èƒ½å½±å“ï¼Œå»ºè®®æ·»åŠ ç´¢å¼•
4. **æ•°æ®éš”ç¦»**: é€šè¿‡ guild_id ç¡®ä¿æ•°æ®éš”ç¦»

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ•°æ®åº“ç´¢å¼•**:

   ```sql
   CREATE INDEX idx_users_nickname ON users(nickname);
   CREATE INDEX idx_guild_members_group_nickname ON guild_members(group_nickname);
   CREATE INDEX idx_signups_team_user ON signups(team_id, signup_user_id, cancelled_at);
   ```

2. **ç¼“å­˜ç­–ç•¥**:

   - ç¾¤ç»„ä¿¡æ¯å¯ä»¥ç¼“å­˜
   - æ˜µç§°æœç´¢ç»“æœå¯ä»¥çŸ­æœŸç¼“å­˜ï¼ˆ5-10 ç§’ï¼‰

3. **åˆ†é¡µæ”¯æŒ**:
   - æ˜µç§°æœç´¢è¿”å›å¤§é‡ç»“æœæ—¶è€ƒè™‘åˆ†é¡µ
   - æŠ¥ååˆ—è¡¨å½“å‰æŒ‰æ—¶é—´æ’åºï¼Œä¸€èˆ¬ä¸ä¼šå¤ªå¤š

---

## ğŸ› å·²çŸ¥é™åˆ¶

1. **æ˜µç§°æœç´¢**:

   - ä¸­æ–‡æ¨¡ç³ŠåŒ¹é…ä¾èµ–æ•°æ®åº“æ’åºè§„åˆ™
   - å»ºè®®æ•°æ®åº“ä½¿ç”¨ UTF-8 ç¼–ç 

2. **æŠ¥ååˆ—è¡¨**:

   - åªè¿”å›æœ‰æ•ˆæŠ¥åï¼ˆcancelled_at ä¸º NULLï¼‰
   - å¦‚éœ€å†å²è®°å½•éœ€å•ç‹¬æ¥å£

3. **è§’è‰²åˆ›å»º**:
   - server é»˜è®¤å€¼ä¾èµ– Guild è¡¨çš„ server å­—æ®µ
   - éœ€ç¡®ä¿ Guild çš„ server å­—æ®µæ­£ç¡®é…ç½®

---

## ğŸ“ åç»­å·¥ä½œ

### æœºå™¨äººç«¯å¼€å‘

1. å®ç°ä»£æŠ¥ååŠŸèƒ½ï¼ˆä½¿ç”¨æ˜µç§°æœç´¢æ¥å£ï¼‰
2. å®ç°ç™»è®°è€æ¿åŠŸèƒ½ï¼ˆåŒä»£æŠ¥åé€»è¾‘ï¼‰
3. å®ç°å–æ¶ˆæŠ¥ååŠŸèƒ½ï¼ˆä½¿ç”¨æŠ¥ååˆ—è¡¨æ¥å£ï¼‰
4. æ·»åŠ ä¼šè¯ç®¡ç†ï¼ˆå¤šæŠ¥åé€‰æ‹©åœºæ™¯ï¼‰

### å¯é€‰ä¼˜åŒ–

1. æ·»åŠ  API é€Ÿç‡é™åˆ¶
2. æ·»åŠ æ“ä½œæ—¥å¿—è®°å½•
3. æ·»åŠ  Webhook é€šçŸ¥
4. æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- æ¥å£æ–‡æ¡£: http://localhost:8000/api/docs
- æµ‹è¯•æŒ‡å—: `backend/test_new_bot_endpoints.md`
- ä½¿ç”¨æŒ‡å—: `backend/BOT_API_ä½¿ç”¨æŒ‡å—.md`
- è¿›åº¦æ–‡æ¡£: `yang_bot/å¼€å‘è¿›åº¦æ€»ç»“.md`

---

**å¼€å‘æ€»ç»“**: æ‰€æœ‰éœ€æ±‚çš„åç«¯æ¥å£å·²å®Œæˆå¼€å‘å¹¶é€šè¿‡ä»£ç æ£€æŸ¥ï¼Œæ— è¯­æ³•é”™è¯¯ã€‚æ¥å£è®¾è®¡åˆç†ï¼Œæ–‡æ¡£å®Œå–„ï¼Œå¯ä»¥ç›´æ¥ç”¨äºæœºå™¨äººé«˜çº§åŠŸèƒ½çš„å¼€å‘ã€‚
