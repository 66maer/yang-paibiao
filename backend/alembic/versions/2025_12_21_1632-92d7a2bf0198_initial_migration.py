"""Initial migration

Revision ID: 92d7a2bf0198
Revises: 
Create Date: 2025-12-21 16:32:54.858495

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '92d7a2bf0198'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    # 先删除依赖表 signups (依赖 teams)
    op.drop_index('idx_signups_cancelled_at', table_name='signups')
    op.drop_index('idx_signups_signup_character_id', table_name='signups')
    op.drop_index('idx_signups_signup_user_id', table_name='signups')
    op.drop_index('idx_signups_submitter_id', table_name='signups')
    op.drop_index('idx_signups_team_id', table_name='signups')
    op.drop_table('signups')

    # 删除依赖表 gold_team_records (依赖 teams)
    op.drop_index('idx_gold_team_records_creator_id', table_name='gold_team_records')
    op.drop_index('idx_gold_team_records_guild_id', table_name='gold_team_records', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_gold_team_records_heibenren_character_id', table_name='gold_team_records')
    op.drop_index('idx_gold_team_records_heibenren_user_id', table_name='gold_team_records')
    op.drop_index('idx_gold_team_records_run_date', table_name='gold_team_records', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_gold_team_records_team_id', table_name='gold_team_records', postgresql_where='(deleted_at IS NULL)')
    op.drop_table('gold_team_records')

    # 删除 teams 表
    op.drop_index('idx_teams_creator_id', table_name='teams')
    op.drop_index('idx_teams_dungeon', table_name='teams', postgresql_where="((status)::text <> 'deleted'::text)")
    op.drop_index('idx_teams_guild_id', table_name='teams', postgresql_where="((status)::text <> 'deleted'::text)")
    op.drop_index('idx_teams_status', table_name='teams')
    op.drop_index('idx_teams_team_time', table_name='teams', postgresql_where="((status)::text <> 'deleted'::text)")
    op.drop_table('teams')

    # 删除 team_templates 表
    op.drop_index('idx_team_templates_creator_id', table_name='team_templates')
    op.drop_index('idx_team_templates_guild_id', table_name='team_templates')
    op.drop_table('team_templates')
    op.alter_column('character_players', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('character_players', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_constraint('character_players_character_id_user_id_key', 'character_players', type_='unique')
    op.drop_index('idx_character_players_character_id', table_name='character_players')
    op.drop_index('idx_character_players_relation_type', table_name='character_players')
    op.drop_index('idx_character_players_user_id', table_name='character_players')
    op.create_index(op.f('ix_character_players_id'), 'character_players', ['id'], unique=False)
    op.drop_table_comment(
        'character_players',
        existing_comment='角色-玩家关联表',
        schema=None
    )
    op.alter_column('characters', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('characters', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('characters', 'deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='删除时间（软删除）',
               existing_comment='删除时间',
               existing_nullable=True)
    op.drop_constraint('characters_name_server_key', 'characters', type_='unique')
    op.drop_index('idx_characters_name', table_name='characters', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_characters_server', table_name='characters', postgresql_where='(deleted_at IS NULL)')
    op.create_index(op.f('ix_characters_id'), 'characters', ['id'], unique=False)
    op.create_index(op.f('ix_characters_name'), 'characters', ['name'], unique=False)
    op.create_index(op.f('ix_characters_server'), 'characters', ['server'], unique=False)
    op.drop_table_comment(
        'characters',
        existing_comment='角色表',
        schema=None
    )
    op.alter_column('guild_members', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='关联ID',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('guild_members', 'role',
               existing_type=sa.VARCHAR(length=20),
               comment='角色: owner, helper, member',
               existing_comment='角色',
               existing_nullable=False)
    op.alter_column('guild_members', 'joined_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='加入时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('guild_members', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('guild_members', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_constraint('guild_members_guild_id_user_id_key', 'guild_members', type_='unique')
    op.drop_index('idx_guild_members_guild_id', table_name='guild_members', postgresql_where='(left_at IS NULL)')
    op.drop_index('idx_guild_members_role', table_name='guild_members', postgresql_where='(left_at IS NULL)')
    op.drop_index('idx_guild_members_user_id', table_name='guild_members', postgresql_where='(left_at IS NULL)')
    op.create_index(op.f('ix_guild_members_id'), 'guild_members', ['id'], unique=False)
    op.drop_constraint('guild_members_guild_id_fkey', 'guild_members', type_='foreignkey')
    op.drop_constraint('guild_members_user_id_fkey', 'guild_members', type_='foreignkey')
    op.create_foreign_key(None, 'guild_members', 'users', ['user_id'], ['id'])
    op.create_foreign_key(None, 'guild_members', 'guilds', ['guild_id'], ['id'])
    op.drop_table_comment(
        'guild_members',
        existing_comment='群组成员表',
        schema=None
    )
    op.alter_column('guild_subscriptions', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='订阅ID',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('guild_subscriptions', 'start_date',
               existing_type=sa.DATE(),
               comment='订阅开始日期',
               existing_comment='开始日期',
               existing_nullable=False)
    op.alter_column('guild_subscriptions', 'end_date',
               existing_type=sa.DATE(),
               comment='订阅结束日期',
               existing_comment='结束日期',
               existing_nullable=False)
    op.alter_column('guild_subscriptions', 'features',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               nullable=False,
               comment='订阅功能配置',
               existing_comment='功能权限配置')
    op.alter_column('guild_subscriptions', 'notes',
               existing_type=sa.TEXT(),
               comment='备注信息',
               existing_comment='备注',
               existing_nullable=True)
    op.alter_column('guild_subscriptions', 'created_by',
               existing_type=sa.INTEGER(),
               nullable=False,
               comment='创建人（管理员ID）',
               existing_comment='创建者')
    op.alter_column('guild_subscriptions', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('guild_subscriptions', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index('idx_guild_subscriptions_end_date', table_name='guild_subscriptions')
    op.drop_index('idx_guild_subscriptions_guild_id', table_name='guild_subscriptions')
    op.create_index(op.f('ix_guild_subscriptions_id'), 'guild_subscriptions', ['id'], unique=False)

    # 清理孤立的 guild_subscriptions 记录（引用不存在的 guilds）
    op.execute("""
        DELETE FROM guild_subscriptions
        WHERE NOT EXISTS (SELECT 1 FROM guilds WHERE guilds.id = guild_subscriptions.guild_id)
    """)

    op.create_foreign_key(None, 'guild_subscriptions', 'guilds', ['guild_id'], ['id'])
    op.drop_table_comment(
        'guild_subscriptions',
        existing_comment='群组订阅权限表',
        schema=None
    )
    op.alter_column('guilds', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='群组ID',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('guilds_id_seq'::regclass)"))
    op.alter_column('guilds', 'guild_qq_number',
               existing_type=sa.VARCHAR(length=20),
               comment='群QQ号',
               existing_comment='群号',
               existing_nullable=False)
    op.alter_column('guilds', 'name',
               existing_type=sa.VARCHAR(length=50),
               comment='群组名称',
               existing_comment='群组名',
               existing_nullable=False)
    op.alter_column('guilds', 'server',
               existing_type=sa.VARCHAR(length=30),
               comment='游戏服务器',
               existing_comment='服务器',
               existing_nullable=False)
    op.alter_column('guilds', 'avatar',
               existing_type=sa.VARCHAR(length=255),
               comment='群组头像URL',
               existing_comment='头像URL',
               existing_nullable=True)
    op.alter_column('guilds', 'owner_id',
               existing_type=sa.INTEGER(),
               nullable=False,
               comment='群主用户ID',
               existing_comment='群主ID')
    op.alter_column('guilds', 'preferences',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               comment='群组偏好设置',
               existing_comment='偏好设置',
               existing_nullable=True)
    op.alter_column('guilds', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('guilds', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_constraint('guilds_guild_qq_number_key', 'guilds', type_='unique')
    op.drop_constraint('guilds_ukey_key', 'guilds', type_='unique')
    op.drop_index('idx_guilds_guild_qq_number', table_name='guilds', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_guilds_owner_id', table_name='guilds', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_guilds_ukey', table_name='guilds', postgresql_where='(deleted_at IS NULL)')
    op.create_index(op.f('ix_guilds_guild_qq_number'), 'guilds', ['guild_qq_number'], unique=True)
    op.create_index(op.f('ix_guilds_id'), 'guilds', ['id'], unique=False)
    op.create_index(op.f('ix_guilds_ukey'), 'guilds', ['ukey'], unique=True)
    op.drop_table_comment(
        'guilds',
        existing_comment='群组表',
        schema=None
    )
    op.alter_column('system_admins', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('system_admins', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index('idx_system_admins_username', table_name='system_admins')
    op.drop_constraint('system_admins_username_key', 'system_admins', type_='unique')
    op.create_index(op.f('ix_system_admins_id'), 'system_admins', ['id'], unique=False)
    op.create_index(op.f('ix_system_admins_username'), 'system_admins', ['username'], unique=True)
    op.drop_table_comment(
        'system_admins',
        existing_comment='系统管理员表',
        schema=None
    )
    op.alter_column('users', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('users', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index('idx_users_deleted_at', table_name='users')
    op.drop_index('idx_users_other_nicknames', table_name='users', postgresql_using='gin')
    op.drop_index('idx_users_qq_number', table_name='users', postgresql_where='(deleted_at IS NULL)')
    op.drop_constraint('users_qq_number_key', 'users', type_='unique')
    op.create_index(op.f('ix_users_id'), 'users', ['id'], unique=False)
    op.create_index(op.f('ix_users_qq_number'), 'users', ['qq_number'], unique=True)
    op.drop_table_comment(
        'users',
        existing_comment='用户表',
        schema=None
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table_comment(
        'users',
        '用户表',
        existing_comment=None,
        schema=None
    )
    op.drop_index(op.f('ix_users_qq_number'), table_name='users')
    op.drop_index(op.f('ix_users_id'), table_name='users')
    op.create_unique_constraint('users_qq_number_key', 'users', ['qq_number'])
    op.create_index('idx_users_qq_number', 'users', ['qq_number'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_users_other_nicknames', 'users', ['other_nicknames'], unique=False, postgresql_using='gin')
    op.create_index('idx_users_deleted_at', 'users', ['deleted_at'], unique=False)
    op.alter_column('users', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('users', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.create_table_comment(
        'system_admins',
        '系统管理员表',
        existing_comment=None,
        schema=None
    )
    op.drop_index(op.f('ix_system_admins_username'), table_name='system_admins')
    op.drop_index(op.f('ix_system_admins_id'), table_name='system_admins')
    op.create_unique_constraint('system_admins_username_key', 'system_admins', ['username'])
    op.create_index('idx_system_admins_username', 'system_admins', ['username'], unique=False)
    op.alter_column('system_admins', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('system_admins', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.create_table_comment(
        'guilds',
        '群组表',
        existing_comment=None,
        schema=None
    )
    op.drop_index(op.f('ix_guilds_ukey'), table_name='guilds')
    op.drop_index(op.f('ix_guilds_id'), table_name='guilds')
    op.drop_index(op.f('ix_guilds_guild_qq_number'), table_name='guilds')
    op.create_index('idx_guilds_ukey', 'guilds', ['ukey'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_guilds_owner_id', 'guilds', ['owner_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_guilds_guild_qq_number', 'guilds', ['guild_qq_number'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_unique_constraint('guilds_ukey_key', 'guilds', ['ukey'])
    op.create_unique_constraint('guilds_guild_qq_number_key', 'guilds', ['guild_qq_number'])
    op.alter_column('guilds', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('guilds', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('guilds', 'preferences',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               comment='偏好设置',
               existing_comment='群组偏好设置',
               existing_nullable=True)
    op.alter_column('guilds', 'owner_id',
               existing_type=sa.INTEGER(),
               nullable=True,
               comment='群主ID',
               existing_comment='群主用户ID')
    op.alter_column('guilds', 'avatar',
               existing_type=sa.VARCHAR(length=255),
               comment='头像URL',
               existing_comment='群组头像URL',
               existing_nullable=True)
    op.alter_column('guilds', 'server',
               existing_type=sa.VARCHAR(length=30),
               comment='服务器',
               existing_comment='游戏服务器',
               existing_nullable=False)
    op.alter_column('guilds', 'name',
               existing_type=sa.VARCHAR(length=50),
               comment='群组名',
               existing_comment='群组名称',
               existing_nullable=False)
    op.alter_column('guilds', 'guild_qq_number',
               existing_type=sa.VARCHAR(length=20),
               comment='群号',
               existing_comment='群QQ号',
               existing_nullable=False)
    op.alter_column('guilds', 'id',
               existing_type=sa.INTEGER(),
               comment='群组ID',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('guilds_id_seq'::regclass)"))
    op.create_table_comment(
        'guild_subscriptions',
        '群组订阅权限表',
        existing_comment=None,
        schema=None
    )
    op.drop_constraint(None, 'guild_subscriptions', type_='foreignkey')
    op.drop_index(op.f('ix_guild_subscriptions_id'), table_name='guild_subscriptions')
    op.create_index('idx_guild_subscriptions_guild_id', 'guild_subscriptions', ['guild_id'], unique=False)
    op.create_index('idx_guild_subscriptions_end_date', 'guild_subscriptions', ['end_date'], unique=False)
    op.alter_column('guild_subscriptions', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('guild_subscriptions', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('guild_subscriptions', 'created_by',
               existing_type=sa.INTEGER(),
               nullable=True,
               comment='创建者',
               existing_comment='创建人（管理员ID）')
    op.alter_column('guild_subscriptions', 'notes',
               existing_type=sa.TEXT(),
               comment='备注',
               existing_comment='备注信息',
               existing_nullable=True)
    op.alter_column('guild_subscriptions', 'features',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               nullable=True,
               comment='功能权限配置',
               existing_comment='订阅功能配置')
    op.alter_column('guild_subscriptions', 'end_date',
               existing_type=sa.DATE(),
               comment='结束日期',
               existing_comment='订阅结束日期',
               existing_nullable=False)
    op.alter_column('guild_subscriptions', 'start_date',
               existing_type=sa.DATE(),
               comment='开始日期',
               existing_comment='订阅开始日期',
               existing_nullable=False)
    op.alter_column('guild_subscriptions', 'id',
               existing_type=sa.INTEGER(),
               comment='订阅ID',
               existing_nullable=False,
               autoincrement=True)
    op.create_table_comment(
        'guild_members',
        '群组成员表',
        existing_comment=None,
        schema=None
    )
    op.drop_constraint(None, 'guild_members', type_='foreignkey')
    op.drop_constraint(None, 'guild_members', type_='foreignkey')
    op.create_foreign_key('guild_members_user_id_fkey', 'guild_members', 'users', ['user_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key('guild_members_guild_id_fkey', 'guild_members', 'guilds', ['guild_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_guild_members_id'), table_name='guild_members')
    op.create_index('idx_guild_members_user_id', 'guild_members', ['user_id'], unique=False, postgresql_where='(left_at IS NULL)')
    op.create_index('idx_guild_members_role', 'guild_members', ['role'], unique=False, postgresql_where='(left_at IS NULL)')
    op.create_index('idx_guild_members_guild_id', 'guild_members', ['guild_id'], unique=False, postgresql_where='(left_at IS NULL)')
    op.create_unique_constraint('guild_members_guild_id_user_id_key', 'guild_members', ['guild_id', 'user_id'])
    op.alter_column('guild_members', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('guild_members', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('guild_members', 'joined_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='加入时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('guild_members', 'role',
               existing_type=sa.VARCHAR(length=20),
               comment='角色',
               existing_comment='角色: owner, helper, member',
               existing_nullable=False)
    op.alter_column('guild_members', 'id',
               existing_type=sa.INTEGER(),
               comment='关联ID',
               existing_nullable=False,
               autoincrement=True)
    op.create_table_comment(
        'characters',
        '角色表',
        existing_comment=None,
        schema=None
    )
    op.drop_index(op.f('ix_characters_server'), table_name='characters')
    op.drop_index(op.f('ix_characters_name'), table_name='characters')
    op.drop_index(op.f('ix_characters_id'), table_name='characters')
    op.create_index('idx_characters_server', 'characters', ['server'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_characters_name', 'characters', ['name'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_unique_constraint('characters_name_server_key', 'characters', ['name', 'server'])
    op.alter_column('characters', 'deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='删除时间',
               existing_comment='删除时间（软删除）',
               existing_nullable=True)
    op.alter_column('characters', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('characters', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.create_table_comment(
        'character_players',
        '角色-玩家关联表',
        existing_comment=None,
        schema=None
    )
    op.drop_index(op.f('ix_character_players_id'), table_name='character_players')
    op.create_index('idx_character_players_user_id', 'character_players', ['user_id'], unique=False)
    op.create_index('idx_character_players_relation_type', 'character_players', ['relation_type'], unique=False)
    op.create_index('idx_character_players_character_id', 'character_players', ['character_id'], unique=False)
    op.create_unique_constraint('character_players_character_id_user_id_key', 'character_players', ['character_id', 'user_id'])
    op.alter_column('character_players', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='更新时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('character_players', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_comment='创建时间',
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.create_table('gold_team_records',
    sa.Column('id', sa.INTEGER(), autoincrement=True, nullable=False, comment='记录ID'),
    sa.Column('guild_id', sa.INTEGER(), autoincrement=False, nullable=False, comment='群组ID'),
    sa.Column('team_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='关联的开团ID（可选）'),
    sa.Column('dungeon', sa.VARCHAR(length=50), autoincrement=False, nullable=False, comment='副本名称'),
    sa.Column('run_date', sa.DATE(), autoincrement=False, nullable=False, comment='开团日期'),
    sa.Column('total_gold', sa.NUMERIC(precision=12, scale=2), server_default=sa.text('0'), autoincrement=False, nullable=True, comment='总金团'),
    sa.Column('worker_count', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True, comment='打工人数'),
    sa.Column('special_drops', postgresql.ARRAY(sa.TEXT()), autoincrement=False, nullable=True, comment='特殊掉落表'),
    sa.Column('heibenren_user_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='黑本人用户ID'),
    sa.Column('heibenren_character_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='黑本人角色ID'),
    sa.Column('heibenren_info', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True, comment='黑本人显示信息'),
    sa.Column('notes', sa.TEXT(), autoincrement=False, nullable=True, comment='备注'),
    sa.Column('creator_id', sa.INTEGER(), autoincrement=False, nullable=False, comment='创建者ID'),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), autoincrement=False, nullable=True, comment='创建时间'),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), autoincrement=False, nullable=True, comment='更新时间'),
    sa.Column('deleted_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True, comment='删除时间'),
    sa.ForeignKeyConstraint(['creator_id'], ['users.id'], name='gold_team_records_creator_id_fkey'),
    sa.ForeignKeyConstraint(['guild_id'], ['guilds.id'], name='gold_team_records_guild_id_fkey', ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['heibenren_character_id'], ['characters.id'], name='gold_team_records_heibenren_character_id_fkey'),
    sa.ForeignKeyConstraint(['heibenren_user_id'], ['users.id'], name='gold_team_records_heibenren_user_id_fkey'),
    sa.ForeignKeyConstraint(['team_id'], ['teams.id'], name='gold_team_records_team_id_fkey', ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name='gold_team_records_pkey'),
    comment='金团记录表'
    )
    op.create_index('idx_gold_team_records_team_id', 'gold_team_records', ['team_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_gold_team_records_run_date', 'gold_team_records', ['run_date'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_gold_team_records_heibenren_user_id', 'gold_team_records', ['heibenren_user_id'], unique=False)
    op.create_index('idx_gold_team_records_heibenren_character_id', 'gold_team_records', ['heibenren_character_id'], unique=False)
    op.create_index('idx_gold_team_records_guild_id', 'gold_team_records', ['guild_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_gold_team_records_creator_id', 'gold_team_records', ['creator_id'], unique=False)
    op.create_table('signups',
    sa.Column('id', sa.INTEGER(), autoincrement=True, nullable=False, comment='报名ID'),
    sa.Column('team_id', sa.INTEGER(), autoincrement=False, nullable=False, comment='开团ID'),
    sa.Column('submitter_id', sa.INTEGER(), autoincrement=False, nullable=False, comment='提交者ID'),
    sa.Column('signup_user_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='报名用户ID'),
    sa.Column('signup_character_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='报名角色ID'),
    sa.Column('signup_info', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True, comment='报名信息'),
    sa.Column('priority', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True, comment='优先级'),
    sa.Column('is_rich', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True, comment='是否老板'),
    sa.Column('is_proxy', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True, comment='是否代报名'),
    sa.Column('slot_position', sa.INTEGER(), autoincrement=False, nullable=True, comment='锁定位置'),
    sa.Column('is_absent', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True, comment='是否缺席'),
    sa.Column('detail', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True, comment='详情'),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), autoincrement=False, nullable=True, comment='创建时间'),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), autoincrement=False, nullable=True, comment='更新时间'),
    sa.Column('cancelled_by', sa.INTEGER(), autoincrement=False, nullable=True, comment='取消者ID'),
    sa.Column('cancelled_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True, comment='取消时间'),
    sa.ForeignKeyConstraint(['cancelled_by'], ['users.id'], name='signups_cancelled_by_fkey'),
    sa.ForeignKeyConstraint(['signup_character_id'], ['characters.id'], name='signups_signup_character_id_fkey'),
    sa.ForeignKeyConstraint(['signup_user_id'], ['users.id'], name='signups_signup_user_id_fkey'),
    sa.ForeignKeyConstraint(['submitter_id'], ['users.id'], name='signups_submitter_id_fkey'),
    sa.ForeignKeyConstraint(['team_id'], ['teams.id'], name='signups_team_id_fkey', ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name='signups_pkey'),
    comment='副本报名表'
    )
    op.create_index('idx_signups_team_id', 'signups', ['team_id'], unique=False)
    op.create_index('idx_signups_submitter_id', 'signups', ['submitter_id'], unique=False)
    op.create_index('idx_signups_signup_user_id', 'signups', ['signup_user_id'], unique=False)
    op.create_index('idx_signups_signup_character_id', 'signups', ['signup_character_id'], unique=False)
    op.create_index('idx_signups_cancelled_at', 'signups', ['cancelled_at'], unique=False)
    op.create_table('team_templates',
    sa.Column('id', sa.INTEGER(), autoincrement=True, nullable=False, comment='模板ID'),
    sa.Column('guild_id', sa.INTEGER(), autoincrement=False, nullable=False, comment='群组ID'),
    sa.Column('creator_id', sa.INTEGER(), autoincrement=False, nullable=False, comment='创建者ID'),
    sa.Column('name', sa.VARCHAR(length=100), autoincrement=False, nullable=False, comment='模板名称'),
    sa.Column('rule', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False, comment='报名规则'),
    sa.Column('notice', sa.TEXT(), autoincrement=False, nullable=True, comment='团队告示'),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), autoincrement=False, nullable=True, comment='创建时间'),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), autoincrement=False, nullable=True, comment='更新时间'),
    sa.ForeignKeyConstraint(['creator_id'], ['users.id'], name='team_templates_creator_id_fkey'),
    sa.ForeignKeyConstraint(['guild_id'], ['guilds.id'], name='team_templates_guild_id_fkey', ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name='team_templates_pkey'),
    comment='开团模板表'
    )
    op.create_index('idx_team_templates_guild_id', 'team_templates', ['guild_id'], unique=False)
    op.create_index('idx_team_templates_creator_id', 'team_templates', ['creator_id'], unique=False)
    op.create_table('teams',
    sa.Column('id', sa.INTEGER(), autoincrement=True, nullable=False, comment='开团ID'),
    sa.Column('guild_id', sa.INTEGER(), autoincrement=False, nullable=False, comment='群组ID'),
    sa.Column('creator_id', sa.INTEGER(), autoincrement=False, nullable=False, comment='创建者ID'),
    sa.Column('title', sa.VARCHAR(length=100), autoincrement=False, nullable=False, comment='开团标题'),
    sa.Column('team_time', postgresql.TIMESTAMP(), autoincrement=False, nullable=False, comment='开团时间'),
    sa.Column('dungeon', sa.VARCHAR(length=50), autoincrement=False, nullable=False, comment='副本名称'),
    sa.Column('max_members', sa.INTEGER(), server_default=sa.text('25'), autoincrement=False, nullable=True, comment='最大人数'),
    sa.Column('is_xuanjing_booked', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True, comment='是否预定玄晶'),
    sa.Column('is_yuntie_booked', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True, comment='是否预定陨铁'),
    sa.Column('is_hidden', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True, comment='是否对成员隐藏（业务逻辑）'),
    sa.Column('is_locked', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True, comment='是否锁定'),
    sa.Column('status', sa.VARCHAR(length=20), server_default=sa.text("'open'::character varying"), autoincrement=False, nullable=True, comment='状态: open(开启), completed(完成), cancelled(取消), deleted(删除)'),
    sa.Column('rule', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False, comment='报名规则'),
    sa.Column('notice', sa.TEXT(), autoincrement=False, nullable=True, comment='团队告示'),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), autoincrement=False, nullable=True, comment='创建时间'),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), autoincrement=False, nullable=True, comment='更新时间'),
    sa.Column('closed_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True, comment='关闭时间'),
    sa.Column('closed_by', sa.INTEGER(), autoincrement=False, nullable=True, comment='关闭者ID'),
    sa.ForeignKeyConstraint(['closed_by'], ['users.id'], name='teams_closed_by_fkey'),
    sa.ForeignKeyConstraint(['creator_id'], ['users.id'], name='teams_creator_id_fkey'),
    sa.ForeignKeyConstraint(['guild_id'], ['guilds.id'], name='teams_guild_id_fkey', ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name='teams_pkey'),
    comment='副本开团表'
    )
    op.create_index('idx_teams_team_time', 'teams', ['team_time'], unique=False, postgresql_where="((status)::text <> 'deleted'::text)")
    op.create_index('idx_teams_status', 'teams', ['status'], unique=False)
    op.create_index('idx_teams_guild_id', 'teams', ['guild_id'], unique=False, postgresql_where="((status)::text <> 'deleted'::text)")
    op.create_index('idx_teams_dungeon', 'teams', ['dungeon'], unique=False, postgresql_where="((status)::text <> 'deleted'::text)")
    op.create_index('idx_teams_creator_id', 'teams', ['creator_id'], unique=False)
    # ### end Alembic commands ###
