name: Build and Deploy

on:
  push:
    branches:
      - "main"
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/yangpaibiao

jobs:
  # æ£€æµ‹ä»£ç å˜åŒ–
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
      bot: ${{ steps.changes.outputs.bot }}
      common: ${{ steps.filter.outputs.common }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            bot:
              - 'yang_bot/**'
            common:
              - '.github/workflows/**'
              - 'docker-compose*.yml'
              - 'deploy.sh'
              - '.env.docker.example'
              - 'scripts/**'

      - name: Determine services to build
        id: changes
        run: |
          # å¦‚æœå…¬å…±æ–‡ä»¶å˜åŒ–ï¼Œåˆ™å…¨éƒ¨é‡æ–°æ„å»º
          if [ "${{ steps.filter.outputs.common }}" == "true" ]; then
            echo "âš ï¸ Common files changed, rebuilding all services"
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "bot=true" >> $GITHUB_OUTPUT
          else
            echo "backend=${{ steps.filter.outputs.backend }}" >> $GITHUB_OUTPUT
            echo "frontend=${{ steps.filter.outputs.frontend }}" >> $GITHUB_OUTPUT
            echo "bot=${{ steps.filter.outputs.bot }}" >> $GITHUB_OUTPUT
          fi

  # æ„å»ºåç«¯é•œåƒ
  build-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          echo "version=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ steps.meta.outputs.version }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:buildcache,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.created=${{ steps.meta.outputs.date }}
            org.opencontainers.image.revision=${{ github.sha }}

  # æ„å»ºå‰ç«¯é•œåƒ
  build-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          echo "version=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          build-args: |
            VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL || '/api/v2' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ steps.meta.outputs.version }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:buildcache,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.created=${{ steps.meta.outputs.date }}
            org.opencontainers.image.revision=${{ github.sha }}

  # æ„å»º Bot é•œåƒ
  build-bot:
    needs: detect-changes
    if: needs.detect-changes.outputs.bot == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          echo "version=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Build and push bot image
        uses: docker/build-push-action@v5
        with:
          context: ./yang_bot
          file: ./yang_bot/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-bot:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-bot:${{ steps.meta.outputs.version }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-bot:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-bot:buildcache,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.created=${{ steps.meta.outputs.date }}
            org.opencontainers.image.revision=${{ github.sha }}

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: [detect-changes, build-backend, build-frontend, build-bot]
    if: |
      always() &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') &&
      (needs.build-bot.result == 'success' || needs.build-bot.result == 'skipped') &&
      (needs.detect-changes.outputs.backend == 'true' ||
       needs.detect-changes.outputs.frontend == 'true' ||
       needs.detect-changes.outputs.bot == 'true')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /home/ubuntu/xiaoyang

            # æ ¹æ®å˜åŒ–æƒ…å†µæ‹‰å–å¯¹åº”çš„é•œåƒï¼ˆä½¿ç”¨å—äº¬å¤§å­¦é•œåƒåŠ é€Ÿï¼‰
            SERVICES_TO_UPDATE=""

            if [ "${{ needs.detect-changes.outputs.backend }}" == "true" ]; then
              echo "ğŸ“¦ Pulling backend image..."
              docker pull ghcr.nju.edu.cn/${{ github.repository_owner }}/yangpaibiao-backend:latest
              SERVICES_TO_UPDATE="$SERVICES_TO_UPDATE backend"
            fi

            if [ "${{ needs.detect-changes.outputs.frontend }}" == "true" ]; then
              echo "ğŸ“¦ Pulling frontend image..."
              docker pull ghcr.nju.edu.cn/${{ github.repository_owner }}/yangpaibiao-frontend:latest
              SERVICES_TO_UPDATE="$SERVICES_TO_UPDATE frontend"
            fi

            if [ "${{ needs.detect-changes.outputs.bot }}" == "true" ]; then
              echo "ğŸ“¦ Pulling bot image..."
              docker pull ghcr.nju.edu.cn/${{ github.repository_owner }}/yangpaibiao-bot:latest
              SERVICES_TO_UPDATE="$SERVICES_TO_UPDATE bot"
            fi

            # è¿è¡Œéƒ¨ç½²è„šæœ¬ï¼ˆä¼ å…¥éœ€è¦æ›´æ–°çš„æœåŠ¡åˆ—è¡¨ï¼‰
            echo "ğŸš€ Deploying services:$SERVICES_TO_UPDATE"
            bash deploy.sh $SERVICES_TO_UPDATE

      - name: Health check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd /home/ubuntu/xiaoyang
            bash scripts/health-check.sh

      - name: Deployment notification
        if: always()
        run: |
          echo "ğŸ“Š Deployment Summary:"
          echo "  Backend:  ${{ needs.detect-changes.outputs.backend == 'true' && 'âœ… Updated' || 'â­ï¸ Skipped' }}"
          echo "  Frontend: ${{ needs.detect-changes.outputs.frontend == 'true' && 'âœ… Updated' || 'â­ï¸ Skipped' }}"
          echo "  Bot:      ${{ needs.detect-changes.outputs.bot == 'true' && 'âœ… Updated' || 'â­ï¸ Skipped' }}"

          if [ "${{ job.status }}" == "success" ]; then
            echo ""
            echo "âœ… Deployment successful!"
          else
            echo ""
            echo "âŒ Deployment failed!"
            exit 1
          fi
